######################################
# Branching Missions Preview Effects #
######################################
enable_branching_mission_review_of_batch = {
	if = {
		limit = { not = { has_country_flag = has_batch_1_active } }
		set_country_flag = has_batch_1_active
		set_country_flag = can_choose_$key$_1_branching_missions
	}
	else_if = {
		limit = { not = { has_country_flag = has_batch_2_active } }
		set_country_flag = has_batch_2_active
		set_country_flag = can_choose_$key$_2_branching_missions
	}
	else = {
		log = "Too many mission batches active at the same time. Make sure that any given moment only 3 batches are active to preview"
	}
}

enable_branching_mission_review = {
	if = {
		limit = { ai = yes }
		country_event = { id = $ai_event_id$ }
	}
	else = {
		custom_tooltip = BYZ_unlock_branches_decision
		hidden_effect = {
			enable_branching_mission_review_of_batch = { key = $key$ }
			change_variable = {
				which = can_preview_missions_var
				value = 1
			}
		}
	}
}
enable_branching_mission_review_without_ai = {
	custom_tooltip = BYZ_unlock_branches_decision
	hidden_effect = {
		enable_branching_mission_review_of_batch = { key = $key$ }
		change_variable = {
			which = can_preview_missions_var
			value = 1
		}
	}
}

select_current_missions_XGG_ULTRAMAR = {
	if = {
		limit = { has_country_flag = Farsight_assimilate_Ultramar }
		
		if = {
			limit = { exists = XGK }
			add_casus_belli = {
				type = cb_vassalize_mission
				target = XGK
				months = 60
			}
		}
	}
	if = {
		limit = { has_country_flag = Farsight_conquest_Ultramar }
		ultima_region = {
			limit = { 
				is_core = XGK
				NOT = { owned_by = ROOT }
				NOT = { is_core = ROOT }
			}
			add_permanent_claim = ROOT 
		}
	}	
}


clr_preview_loc_branch = {
	clr_country_flag = $key$_loc_preview_$batch$_for_1
	clr_country_flag = $key$_loc_preview_$batch$_for_2
	clr_country_flag = $key$_loc_preview_$batch$_for_3
}

select_current_missions = {
    hidden_effect = {
		if = {
			limit = { can_preview_mission_of_key_and_batch = { key = $key$ batch = 1 } }
            clr_country_flag = can_choose_$key$_1_branching_missions
            clr_country_flag = has_batch_1_active
			clr_preview_loc_branch = { key = $key$ batch = 1 }
		}
		if = {
			limit = { can_preview_mission_of_key_and_batch = { key = $key$ batch = 2 } }
            clr_country_flag = can_choose_$key$_2_branching_missions
            clr_country_flag = has_batch_2_active
			clr_preview_loc_branch = { key = $key$ batch = 2 }
		}
        change_variable = {
            which = can_preview_missions_var
            value = -1
        }
    }
    select_current_missions_$key$ = yes
}
select_current_branch = {
	custom_tooltip = BYZ_end_preview
	hidden_effect = { clr_country_flag = has_batch_$batch$_active }
	
	# Farsight ultramar fate
	if = { limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } } select_current_missions = { key = XGG_ULTRAMAR } }
}

clear_all_branching_flags = {
	#Farsight ultramar fate
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } }
		clr_preview_loc_branch = { key = XGG_ULTRAMAR batch = $batch$ }
		clr_country_flag = Farsight_assimilate_Ultramar
		clr_country_flag = Farsight_conquest_Ultramar
	}
}

set_preview_loc_branch = {
	set_country_flag = $key$_loc_preview_$batch$_for_$branch$
}

preview_mission_branch_1 = {
	#Farsight ultramar fate
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } }
		set_preview_loc_branch = { key = XGG_ULTRAMAR batch = $batch$ branch = 1 }
		set_country_flag = Farsight_assimilate_Ultramar
		custom_tooltip = Farsight_assimilate_Ultramar_preview
	}
}
preview_mission_branch_2 = {
	#Farsight ultramar fate
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } }
		set_preview_loc_branch = { key = XGG_ULTRAMAR batch = $batch$ branch = 2 }
		set_country_flag = Farsight_conquest_Ultramar
		custom_tooltip = Farsight_conquest_Ultramar_preview
	}
}

preview_mission_branch_3 = { 
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } }
	
		#do nothing. it's to avoid error
	}
}
preview_mission_branch_4 = { 
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } }
	
		#do nothing. it's to avoid error
	}
}
preview_mission_branch_5 = { 
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = XGG_ULTRAMAR batch = $batch$ } }
	
		#do nothing. it's to avoid error
	}
}

preview_mission_branch = {
	clear_all_branching_flags = { batch = $batch$ }
	preview_mission_branch_$branch$ = { batch = $batch$ }
	hidden_effect = { swap_non_generic_missions = yes }
}

clear_preview_mission_key = {
	if = {
		limit = { can_preview_mission_of_key_and_batch = { key = $key$ batch = $batch$ } }
		clr_country_flag = can_choose_$key$_$batch$_branching_missions
		clr_preview_loc_branch = { key = $key$ batch = $batch$ }
	}
}
clear_preview_mission_keys_for_batch = {
	#Farsight ultramar fate
	clear_preview_mission_key = { batch = $batch$ key = XGG_ULTRAMAR }
	
	clr_country_flag = has_batch_$batch$_active
}

clear_mismatching_mission_key = {
	if = {
		limit = { has_mission_and_key_mismatch = { mission = $mission$ key = $key$ } }
		clr_country_flag = can_choose_$key$_$batch$_branching_missions
		clr_preview_loc_branch = { key = $key$ batch = $batch$ }
	}
}
clear_mismatching_mission_keys_for_batch = {
	#Farsight ultramar fate
	clear_mismatching_mission_key = { mission = fate_of_ultramar				key = XGG_ULTRAMAR batch = $batch$ }
	
	clr_country_flag = has_batch_$batch$_active
	change_variable = {
		which = can_preview_missions_var
		value = -1
	}
}

update_mission_previews = {
	hidden_effect = {
		if = {
			limit = {
				NOT = { has_branching_missions = yes }
				has_any_previewable_batch_active = yes
			}
			clear_preview_mission_keys_for_batch = { batch = 1 }
			clear_preview_mission_keys_for_batch = { batch = 2 }
			clear_preview_mission_keys_for_batch = { batch = 3 }
			set_variable = {
				which = can_preview_missions_var
				value = 0
			}
		}
		if = {
			limit = {
				has_branching_missions = yes
				has_any_mission_and_key_mismatch = yes
			}
			clear_mismatching_mission_keys_for_batch = { batch = 1 }
			clear_mismatching_mission_keys_for_batch = { batch = 2 }
			clear_mismatching_mission_keys_for_batch = { batch = 3 }
		}
	}
}